<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project Tracer: /home/shraiwi/Documents/GitHub/tracer/main/include/tracer.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Project Tracer
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_5c982d53a68cdbcd421152b4020263a9.html">main</a></li><li class="navelem"><a class="el" href="dir_bad007344d42f4b5340fab5412b591e5.html">include</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">tracer.h</div>  </div>
</div><!--header-->
<div class="contents">
<a href="tracer_8h.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="tracer__crypto_8h.html">tracer_crypto.h</a>&quot;</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160; </div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor">#ifndef _TRACER_H_</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor">#define _TRACER_H_</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160; </div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#define TAG &quot;tracer_api&quot;</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160; </div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// gets size (in bytes) of an object&#39;s member.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#define sizeof_member(type, member) sizeof(((type*)0)-&gt;member)</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160; </div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">// settings (timing)</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#define TRACER_SCAN_INTERVAL        1       // how many minutes in between scans</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#define TRACER_TEK_INTERVAL         2       // how many minutes until a new tek is generated. must be divisible by TRACER_ENIN_INTERVAL.</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#define TRACER_ENIN_INTERVAL        1       // how many minutes each eninterval is.</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#define TRACER_SCAN_STORE_PERIOD    28      // how many days to store scans for</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#define TRACER_TEK_STORE_PERIOD     14      // how many tek intervals to store the keys for.</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#define TRACER_ENINS_PER_DAY        (TRACER_TEK_INTERVAL / TRACER_ENIN_INTERVAL)                                // how many enintervals are in a day</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#define TRACER_MINUTES_PER_DAY      (24 * 60)                                                                   // how many minutes there are in a day</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#define TRACER_SCAN_EXPIRY          (TRACER_MINUTES_PER_DAY * TRACER_SCAN_STORE_PERIOD / TRACER_SCAN_INTERVAL)  // how many scan intervals to store scans for</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#define TRACER_ENIN_EXPIRY          (TRACER_TEK_STORE_PERIOD * TRACER_ENINS_PER_DAY)                            // how many enintervalnumbers to store data for</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160; </div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">// settings (metadata)</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#define TRACER_MAJOR_VERSION    1       // standard major version x.0</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#define TRACER_MINOR_VERSION    0       // standard minor version 0.x</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160; </div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">// constants</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#define RPI_STRING  &quot;EN-RPI&quot;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#define RPIK_STRING &quot;EN-RPIK&quot;</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#define AEM_STRING  &quot;EN-AEM&quot;</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#define AEMK_STRING &quot;EN-AEMK&quot;</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160; </div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#if TRACER_TEK_INTERVAL % TRACER_ENIN_INTERVAL !=  0</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#error The tracer tek interval must be divisible by the tracer enin interval!</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160; </div>
<div class="line"><a name="l00044"></a><span class="lineno"><a class="line" href="structtracer__tek.html">   44</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    uint32_t epoch;     </div>
<div class="line"><a name="l00046"></a><span class="lineno"><a class="line" href="structtracer__tek.html#a96c996c14ed845f2cca00ea0b7122ff9">   46</a></span>&#160;    uint8_t value[16];  </div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;} <a class="code" href="structtracer__tek.html">tracer_tek</a>;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160; </div>
<div class="line"><a name="l00052"></a><span class="lineno"><a class="line" href="structtracer__rpi.html">   52</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    uint8_t value[16];  </div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;} <a class="code" href="structtracer__rpi.html">tracer_rpi</a>;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160; </div>
<div class="line"><a name="l00059"></a><span class="lineno"><a class="line" href="structtracer__rpik.html">   59</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    uint8_t value[16];  </div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;} <a class="code" href="structtracer__rpik.html">tracer_rpik</a>;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160; </div>
<div class="line"><a name="l00066"></a><span class="lineno"><a class="line" href="structtracer__aem.html">   66</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    uint8_t value[4];   </div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;} <a class="code" href="structtracer__aem.html">tracer_aem</a>;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160; </div>
<div class="line"><a name="l00073"></a><span class="lineno"><a class="line" href="structtracer__aemk.html">   73</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    uint8_t value[16];  </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;} <a class="code" href="structtracer__aemk.html">tracer_aemk</a>;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160; </div>
<div class="line"><a name="l00080"></a><span class="lineno"><a class="line" href="structtracer__metadata.html">   80</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    uint8_t value[4];   </div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;} <a class="code" href="structtracer__metadata.html">tracer_metadata</a>;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160; </div>
<div class="line"><a name="l00087"></a><span class="lineno"><a class="line" href="structtracer__datapair.html">   87</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <a class="code" href="structtracer__rpi.html">tracer_rpi</a> rpi;     </div>
<div class="line"><a name="l00089"></a><span class="lineno"><a class="line" href="structtracer__datapair.html#ad5b84add561fa54c6117d27201efe55e">   89</a></span>&#160;    <a class="code" href="structtracer__aem.html">tracer_aem</a> <a class="code" href="structtracer__datapair.html#ad5b84add561fa54c6117d27201efe55e">aem</a>;     </div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;} <a class="code" href="structtracer__datapair.html">tracer_datapair</a>;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160; </div>
<div class="line"><a name="l00095"></a><span class="lineno"><a class="line" href="structtracer__keypair.html">   95</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <a class="code" href="structtracer__rpik.html">tracer_rpik</a> rpik;   </div>
<div class="line"><a name="l00097"></a><span class="lineno"><a class="line" href="structtracer__keypair.html#a6d83577d61e28497337bf7719e088f21">   97</a></span>&#160;    <a class="code" href="structtracer__aemk.html">tracer_aemk</a> <a class="code" href="structtracer__keypair.html#a6d83577d61e28497337bf7719e088f21">aemk</a>;   </div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;} <a class="code" href="structtracer__keypair.html">tracer_keypair</a>;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160; </div>
<div class="line"><a name="l00103"></a><span class="lineno"><a class="line" href="structtracer__ble__payload.html">  103</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    uint8_t value[31];  </div>
<div class="line"><a name="l00105"></a><span class="lineno"><a class="line" href="structtracer__ble__payload.html#a01ce49df2077493c970a2f15e9d9bd09">  105</a></span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="structtracer__ble__payload.html#a01ce49df2077493c970a2f15e9d9bd09">len</a>;         </div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;} <a class="code" href="structtracer__ble__payload.html">tracer_ble_payload</a>;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160; </div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<a class="code" href="structtracer__tek.html">tracer_tek</a> tracer_tek_array[TRACER_TEK_STORE_PERIOD];</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="keywordtype">size_t</span> tracer_tek_array_head = 0;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160; </div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<a class="code" href="structtracer__keypair.html">tracer_keypair</a> tracer_current_keypair;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160; </div>
<div class="line"><a name="l00121"></a><span class="lineno"><a class="line" href="tracer_8h.html#a3742f10381020abbd637d4f5ddec3891">  121</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="tracer_8h.html#a3742f10381020abbd637d4f5ddec3891">tracer_ble_payload_add_record</a>(<a class="code" href="structtracer__ble__payload.html">tracer_ble_payload</a> * ble_payload, uint8_t type, <span class="keywordtype">void</span> * data, <span class="keywordtype">size_t</span> data_len) {</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    ble_payload-&gt;value[ble_payload-&gt;<a class="code" href="structtracer__ble__payload.html#a01ce49df2077493c970a2f15e9d9bd09">len</a>++] = data_len + 1;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    ble_payload-&gt;value[ble_payload-&gt;<a class="code" href="structtracer__ble__payload.html#a01ce49df2077493c970a2f15e9d9bd09">len</a>++] = type;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    memcpy(&amp;ble_payload-&gt;value[ble_payload-&gt;<a class="code" href="structtracer__ble__payload.html#a01ce49df2077493c970a2f15e9d9bd09">len</a>], data, data_len);</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    ble_payload-&gt;<a class="code" href="structtracer__ble__payload.html#a01ce49df2077493c970a2f15e9d9bd09">len</a> += data_len;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;}</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160; </div>
<div class="line"><a name="l00134"></a><span class="lineno"><a class="line" href="tracer_8h.html#a4a35291fe76864b6ceb28dc91530cafd">  134</a></span>&#160;uint32_t <a class="code" href="tracer_8h.html#a4a35291fe76864b6ceb28dc91530cafd">tracer_en_interval_number</a>(uint32_t epoch) {</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="keywordflow">return</span> (uint32_t)(epoch / (60 * TRACER_ENIN_INTERVAL));</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;}</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160; </div>
<div class="line"><a name="l00144"></a><span class="lineno"><a class="line" href="tracer_8h.html#acbcdbab25c515d737b4db4f198443b15">  144</a></span>&#160;uint32_t <a class="code" href="tracer_8h.html#acbcdbab25c515d737b4db4f198443b15">tracer_scan_interval_number</a>(uint32_t epoch) {</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="keywordflow">return</span> (uint32_t)(epoch / (60 * TRACER_SCAN_INTERVAL));</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;}</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160; </div>
<div class="line"><a name="l00154"></a><span class="lineno"><a class="line" href="tracer_8h.html#a513d72ec8ee52ad99d5f5d388ae75b70">  154</a></span>&#160;<a class="code" href="structtracer__rpik.html">tracer_rpik</a> <a class="code" href="tracer_8h.html#a513d72ec8ee52ad99d5f5d388ae75b70">tracer_derive_rpik</a>(<a class="code" href="structtracer__tek.html">tracer_tek</a> tek) {</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="keywordtype">char</span> salt[16] = RPIK_STRING;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160; </div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <a class="code" href="structtracer__rpik.html">tracer_rpik</a> out;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160; </div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    <a class="code" href="tracer__crypto_8h.html#ac0fcbd2b648afb9125c7ce5909fc44ae">hkdf</a>(tek.<a class="code" href="structtracer__tek.html#a96c996c14ed845f2cca00ea0b7122ff9">value</a>, AES128_KEY_SIZE,</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        NULL, 0, </div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        salt, 16,</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        16, </div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        out.value);</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160; </div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <span class="keywordflow">return</span> out;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;}</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160; </div>
<div class="line"><a name="l00175"></a><span class="lineno"><a class="line" href="tracer_8h.html#af2acdc5098bfd7ab07cfd053f059962e">  175</a></span>&#160;<a class="code" href="structtracer__rpi.html">tracer_rpi</a> <a class="code" href="tracer_8h.html#af2acdc5098bfd7ab07cfd053f059962e">tracer_derive_rpi</a>(<a class="code" href="structtracer__rpik.html">tracer_rpik</a> rpik, uint32_t epoch) {</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <a class="code" href="structtracer__rpi.html">tracer_rpi</a> out;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160; </div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    uint8_t padded_data[AES128_BLOCK_SIZE] = RPI_STRING;                             <span class="comment">// just a note, the rest of the char array will be initialized to 0</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160; </div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    uint32_t enin = <a class="code" href="tracer_8h.html#a4a35291fe76864b6ceb28dc91530cafd">tracer_en_interval_number</a>(epoch);                                <span class="comment">// get the enintervalnumber</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160; </div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    memcpy(&amp;padded_data[<span class="keyword">sizeof</span>(padded_data) - <span class="keyword">sizeof</span>(enin)], &amp;enin, <span class="keyword">sizeof</span>(enin));   <span class="comment">// set the last 4 bytes of the padded date to the epoch</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160; </div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <a class="code" href="tracer__crypto_8h.html#a8bea96c38a1ee4512de161bbd4a9c3cf">encrypt_aes_block</a>(rpik.value, AES128_KEY_SIZE, &amp;padded_data, out.value);</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160; </div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    <span class="keywordflow">return</span> out;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;}</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160; </div>
<div class="line"><a name="l00196"></a><span class="lineno"><a class="line" href="tracer_8h.html#a0aadea78bf29be28f5822988e1be642a">  196</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="tracer_8h.html#a0aadea78bf29be28f5822988e1be642a">tracer_compare_datapairs</a>(<a class="code" href="structtracer__datapair.html">tracer_datapair</a> a, <a class="code" href="structtracer__datapair.html">tracer_datapair</a> b) {</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <span class="keywordflow">return</span> memcmp(&amp;a.<a class="code" href="structtracer__datapair.html#ad5b84add561fa54c6117d27201efe55e">aem</a>.value, &amp;b.<a class="code" href="structtracer__datapair.html#ad5b84add561fa54c6117d27201efe55e">aem</a>.value, <span class="keyword">sizeof</span>(a.<a class="code" href="structtracer__datapair.html#ad5b84add561fa54c6117d27201efe55e">aem</a>.value)) == 0 &amp;&amp; memcmp(&amp;a.rpi.value, &amp;b.rpi.value, <span class="keyword">sizeof</span>(a.rpi.value)) == 0;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;}</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160; </div>
<div class="line"><a name="l00206"></a><span class="lineno"><a class="line" href="tracer_8h.html#a6dad82131e380a50b8f558121f9b0fe3">  206</a></span>&#160;<a class="code" href="structtracer__metadata.html">tracer_metadata</a> <a class="code" href="tracer_8h.html#a6dad82131e380a50b8f558121f9b0fe3">tracer_derive_metadata</a>(int8_t tx_power) {</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <a class="code" href="structtracer__metadata.html">tracer_metadata</a> out;</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    memset(out.value, 0, <span class="keyword">sizeof</span>(out.value));</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160; </div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    out.value[0] =                              <span class="comment">// major &amp; minor versioning</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        (TRACER_MAJOR_VERSION &amp; 0b11) &lt;&lt; 6 |</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        (TRACER_MINOR_VERSION &amp; 0b11) &lt;&lt; 4;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    out.value[1] = tx_power;                    <span class="comment">// transmit tx_power</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160; </div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keywordflow">return</span> out;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;}</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160; </div>
<div class="line"><a name="l00224"></a><span class="lineno"><a class="line" href="tracer_8h.html#a109dfea4b92ad8581825c696865489ce">  224</a></span>&#160;<a class="code" href="structtracer__aemk.html">tracer_aemk</a> <a class="code" href="tracer_8h.html#a109dfea4b92ad8581825c696865489ce">tracer_derive_aemk</a>(<a class="code" href="structtracer__tek.html">tracer_tek</a> tek) {</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <a class="code" href="structtracer__aemk.html">tracer_aemk</a> out;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160; </div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    uint8_t info[AES128_BLOCK_SIZE] = AEMK_STRING;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160; </div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <a class="code" href="tracer__crypto_8h.html#ac0fcbd2b648afb9125c7ce5909fc44ae">hkdf</a>(tek.<a class="code" href="structtracer__tek.html#a96c996c14ed845f2cca00ea0b7122ff9">value</a>, <span class="keyword">sizeof</span>(tek.<a class="code" href="structtracer__tek.html#a96c996c14ed845f2cca00ea0b7122ff9">value</a>),</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        NULL, 0, </div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        info, <span class="keyword">sizeof</span>(info), <span class="keyword">sizeof</span>(out.value), out.value);</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160; </div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keywordflow">return</span> out;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;}</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160; </div>
<div class="line"><a name="l00244"></a><span class="lineno"><a class="line" href="tracer_8h.html#a631562f73427c2710771736e1a521089">  244</a></span>&#160;<a class="code" href="structtracer__aem.html">tracer_aem</a> <a class="code" href="tracer_8h.html#a631562f73427c2710771736e1a521089">tracer_derive_aem</a>(<a class="code" href="structtracer__aemk.html">tracer_aemk</a> aemk, <a class="code" href="structtracer__rpi.html">tracer_rpi</a> rpi, <a class="code" href="structtracer__metadata.html">tracer_metadata</a> metadata) {</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <a class="code" href="structtracer__aem.html">tracer_aem</a> out;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160; </div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <a class="code" href="tracer__crypto_8h.html#a2e31ec2155c3ba41fa15169deecd1f05">flip_aes_block_ctr</a>(aemk.value, AES128_KEY_SIZE, rpi.value, metadata.value, <span class="keyword">sizeof</span>(metadata.value), out.value);</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160; </div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="keywordflow">return</span> out;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;}</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160; </div>
<div class="line"><a name="l00258"></a><span class="lineno"><a class="line" href="tracer_8h.html#a5e2a646f64065538e3f42937beb61454">  258</a></span>&#160;<a class="code" href="structtracer__keypair.html">tracer_keypair</a> <a class="code" href="tracer_8h.html#a5e2a646f64065538e3f42937beb61454">tracer_derive_keypair</a>(<a class="code" href="structtracer__tek.html">tracer_tek</a> tek) {</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <a class="code" href="structtracer__keypair.html">tracer_keypair</a> out;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    out.rpik = <a class="code" href="tracer_8h.html#a513d72ec8ee52ad99d5f5d388ae75b70">tracer_derive_rpik</a>(tek);</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    out.<a class="code" href="structtracer__keypair.html#a6d83577d61e28497337bf7719e088f21">aemk</a> = <a class="code" href="tracer_8h.html#a109dfea4b92ad8581825c696865489ce">tracer_derive_aemk</a>(tek);</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="keywordflow">return</span> out;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;}</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160; </div>
<div class="line"><a name="l00271"></a><span class="lineno"><a class="line" href="tracer_8h.html#a8a38ceec0a0cb58bc87e43287d8cea57">  271</a></span>&#160;<a class="code" href="structtracer__ble__payload.html">tracer_ble_payload</a> <a class="code" href="tracer_8h.html#a8a38ceec0a0cb58bc87e43287d8cea57">tracer_derive_ble_payload</a>(<a class="code" href="structtracer__datapair.html">tracer_datapair</a> datapair) {</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <a class="code" href="structtracer__ble__payload.html">tracer_ble_payload</a> out;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    </div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    uint8_t flags[]          =  { 0x1a };</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    uint8_t uuid[]           =  { 0x6f, 0xfd };     <span class="comment">// the ESP32 is little-endian, and so is BLE. However, human readable stuff is big-endian.</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    uint8_t service_data[2 </div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        + <span class="keyword">sizeof</span>(datapair.rpi.value) </div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        + <span class="keyword">sizeof</span>(datapair.<a class="code" href="structtracer__datapair.html#ad5b84add561fa54c6117d27201efe55e">aem</a>.value)] =  { 0x6f, 0xfd };</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    </div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    memcpy(service_data + 2, datapair.rpi.value, <span class="keyword">sizeof</span>(datapair.rpi.value));</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    memcpy(service_data + 2 + <span class="keyword">sizeof</span>(datapair.rpi.value), datapair.<a class="code" href="structtracer__datapair.html#ad5b84add561fa54c6117d27201efe55e">aem</a>.value, <span class="keyword">sizeof</span>(datapair.<a class="code" href="structtracer__datapair.html#ad5b84add561fa54c6117d27201efe55e">aem</a>.value));</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    </div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    out.<a class="code" href="structtracer__ble__payload.html#a01ce49df2077493c970a2f15e9d9bd09">len</a> = 0;        <span class="comment">// haha, it was YOU! darn you, uninitialized values!</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160; </div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <a class="code" href="tracer_8h.html#a3742f10381020abbd637d4f5ddec3891">tracer_ble_payload_add_record</a>(&amp;out, 0x01, flags,        <span class="keyword">sizeof</span>(flags));         <span class="comment">// set bluetooth flags</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    <a class="code" href="tracer_8h.html#a3742f10381020abbd637d4f5ddec3891">tracer_ble_payload_add_record</a>(&amp;out, 0x03, uuid,         <span class="keyword">sizeof</span>(uuid));          <span class="comment">// set service uuid</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <a class="code" href="tracer_8h.html#a3742f10381020abbd637d4f5ddec3891">tracer_ble_payload_add_record</a>(&amp;out, 0x16, service_data, <span class="keyword">sizeof</span>(service_data));  <span class="comment">// set service data</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160; </div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    <span class="keywordflow">return</span> out;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;}</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160; </div>
<div class="line"><a name="l00298"></a><span class="lineno"><a class="line" href="tracer_8h.html#a6df351c545f88109e4fa00d687c7c7ca">  298</a></span>&#160;<a class="code" href="structtracer__tek.html">tracer_tek</a> * <a class="code" href="tracer_8h.html#a6df351c545f88109e4fa00d687c7c7ca">tracer_derive_tek</a>(uint32_t epoch) {</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <a class="code" href="structtracer__tek.html">tracer_tek</a> * out = &amp;tracer_tek_array[tracer_tek_array_head++];</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    tracer_tek_array_head %= TRACER_TEK_STORE_PERIOD;</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    out-&gt;epoch = epoch;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <a class="code" href="tracer__crypto_8h.html#af5b3ac97a21f6b1a57fe2b2e435e2e15">rng_gen</a>(<span class="keyword">sizeof</span>(out-&gt;<a class="code" href="structtracer__tek.html#a96c996c14ed845f2cca00ea0b7122ff9">value</a>), out-&gt;<a class="code" href="structtracer__tek.html#a96c996c14ed845f2cca00ea0b7122ff9">value</a>);</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160; </div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    tracer_current_keypair = <a class="code" href="tracer_8h.html#a5e2a646f64065538e3f42937beb61454">tracer_derive_keypair</a>(*out);</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160; </div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="keywordflow">return</span> out;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;}</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160; </div>
<div class="line"><a name="l00314"></a><span class="lineno"><a class="line" href="tracer_8h.html#a71cc1557149895133059388f0e60f57a">  314</a></span>&#160;<a class="code" href="structtracer__tek.html">tracer_tek</a> <a class="code" href="tracer_8h.html#a71cc1557149895133059388f0e60f57a">tracer_get_latest_tek</a>() {</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    <span class="keywordflow">return</span> tracer_tek_array[(tracer_tek_array_head ? tracer_tek_array_head : TRACER_TEK_STORE_PERIOD) - 1];</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;}</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160; </div>
<div class="line"><a name="l00325"></a><span class="lineno"><a class="line" href="tracer_8h.html#a8d79eac8cf4cd46c8966ed8accc0d370">  325</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="tracer_8h.html#a8d79eac8cf4cd46c8966ed8accc0d370">tracer_parse_ble_payload</a>(<a class="code" href="structtracer__ble__payload.html">tracer_ble_payload</a> payload, <a class="code" href="structtracer__datapair.html">tracer_datapair</a> * datapair) {</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160; </div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <span class="keywordtype">bool</span> output_valid = <span class="keyword">false</span>, payload_valid = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; payload.<a class="code" href="structtracer__ble__payload.html#a01ce49df2077493c970a2f15e9d9bd09">len</a>;) {</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        uint8_t record_len = payload.value[i++];</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160; </div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        <span class="keywordflow">if</span> (i + record_len &gt; payload.<a class="code" href="structtracer__ble__payload.html#a01ce49df2077493c970a2f15e9d9bd09">len</a>) <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// segfault bad. &gt;:( this protects the parser from them.</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160; </div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        uint8_t type = payload.value[i++];</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160; </div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        uint8_t * data = payload.value + i;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        uint8_t data_len = record_len - 1;</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160; </div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        <span class="keywordflow">switch</span> (type) {</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;            <span class="keywordflow">case</span> 0x03:  <span class="comment">// service uuid</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                payload_valid = *(uint16_t *)(data) == 0xFD6F; <span class="comment">// check if the service id matches the contact tracing standard</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;            <span class="keywordflow">case</span> 0x16:  <span class="comment">// service data</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                <span class="keywordflow">if</span> (data_len == 2 + <span class="keyword">sizeof</span>(datapair-&gt;rpi.value) + <span class="keyword">sizeof</span>(datapair-&gt;<a class="code" href="structtracer__datapair.html#ad5b84add561fa54c6117d27201efe55e">aem</a>.value)) {    <span class="comment">// check if the package is the right size</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;                    <span class="keywordflow">if</span> (datapair) {</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                        memcpy(datapair-&gt;rpi.value, data + 2, <span class="keyword">sizeof</span>(datapair-&gt;rpi.value));</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                        memcpy(datapair-&gt;<a class="code" href="structtracer__datapair.html#ad5b84add561fa54c6117d27201efe55e">aem</a>.value, data + 2 + <span class="keyword">sizeof</span>(datapair-&gt;rpi.value), <span class="keyword">sizeof</span>(datapair-&gt;<a class="code" href="structtracer__datapair.html#ad5b84add561fa54c6117d27201efe55e">aem</a>.value));</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                    }</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                    output_valid = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                }</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        }</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;        i += data_len;</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    }</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160; </div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keywordflow">return</span> output_valid &amp;&amp; payload_valid;</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;}</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160; </div>
<div class="line"><a name="l00365"></a><span class="lineno"><a class="line" href="tracer_8h.html#ac10f55b7d776b6fdc6b70c3e0dd4de39">  365</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="tracer_8h.html#ac10f55b7d776b6fdc6b70c3e0dd4de39">tracer_detect_enin_rollover</a>(uint32_t last_epoch, uint32_t current_epoch) {</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <span class="keywordflow">return</span> (<a class="code" href="tracer_8h.html#a4a35291fe76864b6ceb28dc91530cafd">tracer_en_interval_number</a>(last_epoch) &lt; <a class="code" href="tracer_8h.html#a4a35291fe76864b6ceb28dc91530cafd">tracer_en_interval_number</a>(current_epoch));</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;}</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160; </div>
<div class="line"><a name="l00376"></a><span class="lineno"><a class="line" href="tracer_8h.html#a58173ac16d4cb9eb3a115955b1d28b65">  376</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="tracer_8h.html#a58173ac16d4cb9eb3a115955b1d28b65">tracer_detect_scanin_rollover</a>(uint32_t last_epoch, uint32_t current_epoch) {</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="keywordflow">return</span> (<a class="code" href="tracer_8h.html#acbcdbab25c515d737b4db4f198443b15">tracer_scan_interval_number</a>(last_epoch) &lt; <a class="code" href="tracer_8h.html#acbcdbab25c515d737b4db4f198443b15">tracer_scan_interval_number</a>(current_epoch));</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;}</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160; </div>
<div class="line"><a name="l00387"></a><span class="lineno"><a class="line" href="tracer_8h.html#ad19adbc4b2555468a65e65d701c2e4a8">  387</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="tracer_8h.html#ad19adbc4b2555468a65e65d701c2e4a8">tracer_detect_tek_rollover</a>(uint32_t last_epoch, uint32_t current_epoch) {</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    uint32_t last_enin = <a class="code" href="tracer_8h.html#a4a35291fe76864b6ceb28dc91530cafd">tracer_en_interval_number</a>(last_epoch), current_enin = <a class="code" href="tracer_8h.html#a4a35291fe76864b6ceb28dc91530cafd">tracer_en_interval_number</a>(current_epoch);</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    <span class="keywordflow">return</span> ((current_enin &gt; last_enin) &amp;&amp; ((current_enin % TRACER_ENINS_PER_DAY) == 0)) || (current_enin - last_enin &gt;= TRACER_ENINS_PER_DAY);</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;}</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160; </div>
<div class="line"><a name="l00401"></a><span class="lineno"><a class="line" href="tracer_8h.html#ab8dea46c9d02bd743e7cc04fe43cb5a5">  401</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="tracer_8h.html#ab8dea46c9d02bd743e7cc04fe43cb5a5">tracer_verify</a>(<a class="code" href="structtracer__datapair.html">tracer_datapair</a> datapair, <a class="code" href="structtracer__tek.html">tracer_tek</a> tek, uint32_t * enin, <a class="code" href="structtracer__metadata.html">tracer_metadata</a> * output_metadata) {</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    <a class="code" href="structtracer__rpik.html">tracer_rpik</a> rpik = <a class="code" href="tracer_8h.html#a513d72ec8ee52ad99d5f5d388ae75b70">tracer_derive_rpik</a>(tek);</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160; </div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    uint8_t * decrypted_rpi = (uint8_t *)<a class="code" href="tracer__crypto_8h.html#a145936a52c2c85393fdd22b24638cfc0">decrypt_aes_block</a>(rpik.value, <span class="keyword">sizeof</span>(rpik.value), datapair.rpi.value, NULL);</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160; </div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="keywordtype">bool</span> valid = memcmp(decrypted_rpi, RPI_STRING, <span class="keyword">sizeof</span>(RPI_STRING)) == 0;</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160; </div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <span class="keywordflow">if</span> (valid) {</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;        <span class="keywordflow">if</span> (enin) *enin = *(uint32_t*)(decrypted_rpi + AES128_BLOCK_SIZE - <span class="keyword">sizeof</span>(uint32_t));</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;        <span class="keywordflow">if</span> (output_metadata) {</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;            <a class="code" href="structtracer__aemk.html">tracer_aemk</a> aemk = <a class="code" href="tracer_8h.html#a109dfea4b92ad8581825c696865489ce">tracer_derive_aemk</a>(tek);</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;            <a class="code" href="tracer__crypto_8h.html#a2e31ec2155c3ba41fa15169deecd1f05">flip_aes_block_ctr</a>(aemk.value, AES128_KEY_SIZE, datapair.rpi.value, datapair.<a class="code" href="structtracer__datapair.html#ad5b84add561fa54c6117d27201efe55e">aem</a>.value, <span class="keyword">sizeof</span>(datapair.<a class="code" href="structtracer__datapair.html#ad5b84add561fa54c6117d27201efe55e">aem</a>.value), output_metadata-&gt;value);</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        }</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    }</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160; </div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    free(decrypted_rpi);</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160; </div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    <span class="keywordflow">return</span> valid;</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;}</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160; </div>
<div class="line"><a name="l00427"></a><span class="lineno"><a class="line" href="tracer_8h.html#a36e3c68ffd53218b36de2326be850f01">  427</a></span>&#160;<a class="code" href="structtracer__datapair.html">tracer_datapair</a> <a class="code" href="tracer_8h.html#a36e3c68ffd53218b36de2326be850f01">tracer_derive_datapair</a>(uint32_t epoch, int8_t tx_power) {</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <a class="code" href="structtracer__datapair.html">tracer_datapair</a> out;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160; </div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    <a class="code" href="structtracer__metadata.html">tracer_metadata</a> meta = <a class="code" href="tracer_8h.html#a6dad82131e380a50b8f558121f9b0fe3">tracer_derive_metadata</a>(tx_power);</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160; </div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    out.rpi = <a class="code" href="tracer_8h.html#af2acdc5098bfd7ab07cfd053f059962e">tracer_derive_rpi</a>(tracer_current_keypair.rpik, epoch);</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    out.<a class="code" href="structtracer__datapair.html#ad5b84add561fa54c6117d27201efe55e">aem</a> = <a class="code" href="tracer_8h.html#a631562f73427c2710771736e1a521089">tracer_derive_aem</a>(tracer_current_keypair.<a class="code" href="structtracer__keypair.html#a6d83577d61e28497337bf7719e088f21">aemk</a>, out.rpi, meta);</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160; </div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    <span class="keywordflow">return</span> out;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;}</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160; </div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="preprocessor">#undef TAG</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160; </div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="preprocessor">#endif</span></div>
</div><!-- fragment --></div><!-- contents -->
<div class="ttc" id="atracer__crypto_8h_html"><div class="ttname"><a href="tracer__crypto_8h.html">tracer_crypto.h</a></div><div class="ttdoc">A standard API for all of the cryptographic functions outlined in the preliminary standard (v1....</div></div>
<div class="ttc" id="astructtracer__rpi_html"><div class="ttname"><a href="structtracer__rpi.html">tracer_rpi</a></div><div class="ttdoc">A Rolling Proximity Identifier.</div><div class="ttdef"><b>Definition:</b> tracer.h:52</div></div>
<div class="ttc" id="atracer_8h_html_a3742f10381020abbd637d4f5ddec3891"><div class="ttname"><a href="tracer_8h.html#a3742f10381020abbd637d4f5ddec3891">tracer_ble_payload_add_record</a></div><div class="ttdeci">void tracer_ble_payload_add_record(tracer_ble_payload *ble_payload, uint8_t type, void *data, size_t data_len)</div><div class="ttdoc">Adds a record to the BLE payload.</div><div class="ttdef"><b>Definition:</b> tracer.h:121</div></div>
<div class="ttc" id="atracer_8h_html_a6dad82131e380a50b8f558121f9b0fe3"><div class="ttname"><a href="tracer_8h.html#a6dad82131e380a50b8f558121f9b0fe3">tracer_derive_metadata</a></div><div class="ttdeci">tracer_metadata tracer_derive_metadata(int8_t tx_power)</div><div class="ttdoc">Derives unencrypted metadata.</div><div class="ttdef"><b>Definition:</b> tracer.h:206</div></div>
<div class="ttc" id="astructtracer__ble__payload_html_a01ce49df2077493c970a2f15e9d9bd09"><div class="ttname"><a href="structtracer__ble__payload.html#a01ce49df2077493c970a2f15e9d9bd09">tracer_ble_payload::len</a></div><div class="ttdeci">size_t len</div><div class="ttdef"><b>Definition:</b> tracer.h:105</div></div>
<div class="ttc" id="astructtracer__aemk_html"><div class="ttname"><a href="structtracer__aemk.html">tracer_aemk</a></div><div class="ttdoc">An Associated Encrypted Metadata Key; used to encrypt Associated Encrypted Metadata.</div><div class="ttdef"><b>Definition:</b> tracer.h:73</div></div>
<div class="ttc" id="astructtracer__tek_html"><div class="ttname"><a href="structtracer__tek.html">tracer_tek</a></div><div class="ttdoc">A structure containing a Temporary Exposure Key and a UNIX Epoch signifying its creation time.</div><div class="ttdef"><b>Definition:</b> tracer.h:44</div></div>
<div class="ttc" id="atracer_8h_html_ad19adbc4b2555468a65e65d701c2e4a8"><div class="ttname"><a href="tracer_8h.html#ad19adbc4b2555468a65e65d701c2e4a8">tracer_detect_tek_rollover</a></div><div class="ttdeci">bool tracer_detect_tek_rollover(uint32_t last_epoch, uint32_t current_epoch)</div><div class="ttdoc">Detects if there needs to be a new TEK generated.</div><div class="ttdef"><b>Definition:</b> tracer.h:387</div></div>
<div class="ttc" id="astructtracer__datapair_html_ad5b84add561fa54c6117d27201efe55e"><div class="ttname"><a href="structtracer__datapair.html#ad5b84add561fa54c6117d27201efe55e">tracer_datapair::aem</a></div><div class="ttdeci">tracer_aem aem</div><div class="ttdef"><b>Definition:</b> tracer.h:89</div></div>
<div class="ttc" id="atracer_8h_html_ab8dea46c9d02bd743e7cc04fe43cb5a5"><div class="ttname"><a href="tracer_8h.html#ab8dea46c9d02bd743e7cc04fe43cb5a5">tracer_verify</a></div><div class="ttdeci">bool tracer_verify(tracer_datapair datapair, tracer_tek tek, uint32_t *enin, tracer_metadata *output_metadata)</div><div class="ttdoc">Checks if a scanned RPI and AEM pair matches a downloaded TEK.</div><div class="ttdef"><b>Definition:</b> tracer.h:401</div></div>
<div class="ttc" id="atracer_8h_html_a109dfea4b92ad8581825c696865489ce"><div class="ttname"><a href="tracer_8h.html#a109dfea4b92ad8581825c696865489ce">tracer_derive_aemk</a></div><div class="ttdeci">tracer_aemk tracer_derive_aemk(tracer_tek tek)</div><div class="ttdoc">Derives an corresponding Associated Encrypted Metadata Key from a Temporary Exposure Key.</div><div class="ttdef"><b>Definition:</b> tracer.h:224</div></div>
<div class="ttc" id="astructtracer__tek_html_a96c996c14ed845f2cca00ea0b7122ff9"><div class="ttname"><a href="structtracer__tek.html#a96c996c14ed845f2cca00ea0b7122ff9">tracer_tek::value</a></div><div class="ttdeci">uint8_t value[16]</div><div class="ttdef"><b>Definition:</b> tracer.h:46</div></div>
<div class="ttc" id="astructtracer__datapair_html"><div class="ttname"><a href="structtracer__datapair.html">tracer_datapair</a></div><div class="ttdoc">An RPI and AEM pair.</div><div class="ttdef"><b>Definition:</b> tracer.h:87</div></div>
<div class="ttc" id="atracer__crypto_8h_html_ac0fcbd2b648afb9125c7ce5909fc44ae"><div class="ttname"><a href="tracer__crypto_8h.html#ac0fcbd2b648afb9125c7ce5909fc44ae">hkdf</a></div><div class="ttdeci">uint8_t * hkdf(void *key, size_t key_len, void *salt, size_t salt_len, void *info, size_t info_len, size_t out_len, void *output)</div><div class="ttdoc">A simple key-derivation function.</div><div class="ttdef"><b>Definition:</b> tracer_crypto.h:75</div></div>
<div class="ttc" id="atracer_8h_html_a36e3c68ffd53218b36de2326be850f01"><div class="ttname"><a href="tracer_8h.html#a36e3c68ffd53218b36de2326be850f01">tracer_derive_datapair</a></div><div class="ttdeci">tracer_datapair tracer_derive_datapair(uint32_t epoch, int8_t tx_power)</div><div class="ttdoc">Derives a RPI-AEM pair given a unix epoch and tx power. This can be used to create bluetooth payloads...</div><div class="ttdef"><b>Definition:</b> tracer.h:427</div></div>
<div class="ttc" id="atracer__crypto_8h_html_a8bea96c38a1ee4512de161bbd4a9c3cf"><div class="ttname"><a href="tracer__crypto_8h.html#a8bea96c38a1ee4512de161bbd4a9c3cf">encrypt_aes_block</a></div><div class="ttdeci">uint8_t * encrypt_aes_block(void *key, size_t key_len, void *data, void *output)</div><div class="ttdoc">Encrypts a single block in AES mode.</div><div class="ttdef"><b>Definition:</b> tracer_crypto.h:101</div></div>
<div class="ttc" id="atracer_8h_html_acbcdbab25c515d737b4db4f198443b15"><div class="ttname"><a href="tracer_8h.html#acbcdbab25c515d737b4db4f198443b15">tracer_scan_interval_number</a></div><div class="ttdeci">uint32_t tracer_scan_interval_number(uint32_t epoch)</div><div class="ttdoc">Gets the Scan Interval Number given an epoch.</div><div class="ttdef"><b>Definition:</b> tracer.h:144</div></div>
<div class="ttc" id="atracer__crypto_8h_html_af5b3ac97a21f6b1a57fe2b2e435e2e15"><div class="ttname"><a href="tracer__crypto_8h.html#af5b3ac97a21f6b1a57fe2b2e435e2e15">rng_gen</a></div><div class="ttdeci">uint8_t * rng_gen(size_t len, void *output)</div><div class="ttdoc">Fills or allocates a buffer with crypotgraphically-secure random numbers.</div><div class="ttdef"><b>Definition:</b> tracer_crypto.h:49</div></div>
<div class="ttc" id="atracer_8h_html_a8d79eac8cf4cd46c8966ed8accc0d370"><div class="ttname"><a href="tracer_8h.html#a8d79eac8cf4cd46c8966ed8accc0d370">tracer_parse_ble_payload</a></div><div class="ttdeci">bool tracer_parse_ble_payload(tracer_ble_payload payload, tracer_datapair *datapair)</div><div class="ttdoc">Attempts to parse a raw BLE adverising payload.</div><div class="ttdef"><b>Definition:</b> tracer.h:325</div></div>
<div class="ttc" id="astructtracer__metadata_html"><div class="ttname"><a href="structtracer__metadata.html">tracer_metadata</a></div><div class="ttdoc">A container for unencrypted metadata.</div><div class="ttdef"><b>Definition:</b> tracer.h:80</div></div>
<div class="ttc" id="atracer_8h_html_a513d72ec8ee52ad99d5f5d388ae75b70"><div class="ttname"><a href="tracer_8h.html#a513d72ec8ee52ad99d5f5d388ae75b70">tracer_derive_rpik</a></div><div class="ttdeci">tracer_rpik tracer_derive_rpik(tracer_tek tek)</div><div class="ttdoc">Derives a new Rolling Proximity Identifier Key from a Temporary Exposure Key.</div><div class="ttdef"><b>Definition:</b> tracer.h:154</div></div>
<div class="ttc" id="astructtracer__keypair_html"><div class="ttname"><a href="structtracer__keypair.html">tracer_keypair</a></div><div class="ttdoc">An RPIK and AEMK pair.</div><div class="ttdef"><b>Definition:</b> tracer.h:95</div></div>
<div class="ttc" id="atracer__crypto_8h_html_a145936a52c2c85393fdd22b24638cfc0"><div class="ttname"><a href="tracer__crypto_8h.html#a145936a52c2c85393fdd22b24638cfc0">decrypt_aes_block</a></div><div class="ttdeci">uint8_t * decrypt_aes_block(void *key, size_t key_len, void *data, void *output)</div><div class="ttdoc">Decrypts a single block in AES mode.</div><div class="ttdef"><b>Definition:</b> tracer_crypto.h:133</div></div>
<div class="ttc" id="astructtracer__ble__payload_html"><div class="ttname"><a href="structtracer__ble__payload.html">tracer_ble_payload</a></div><div class="ttdoc">A raw BLE advertising payload.</div><div class="ttdef"><b>Definition:</b> tracer.h:103</div></div>
<div class="ttc" id="astructtracer__rpik_html"><div class="ttname"><a href="structtracer__rpik.html">tracer_rpik</a></div><div class="ttdoc">A Rolling Proximity Identifier Key; used to encrypt Rolling Proximity Identifiers.</div><div class="ttdef"><b>Definition:</b> tracer.h:59</div></div>
<div class="ttc" id="atracer_8h_html_a6df351c545f88109e4fa00d687c7c7ca"><div class="ttname"><a href="tracer_8h.html#a6df351c545f88109e4fa00d687c7c7ca">tracer_derive_tek</a></div><div class="ttdeci">tracer_tek * tracer_derive_tek(uint32_t epoch)</div><div class="ttdoc">Generates a new Temporary Exposure Key and updates the latest keypair.</div><div class="ttdef"><b>Definition:</b> tracer.h:298</div></div>
<div class="ttc" id="astructtracer__aem_html"><div class="ttname"><a href="structtracer__aem.html">tracer_aem</a></div><div class="ttdoc">The Associated Encrypted Metadata to an RPI.</div><div class="ttdef"><b>Definition:</b> tracer.h:66</div></div>
<div class="ttc" id="atracer_8h_html_a631562f73427c2710771736e1a521089"><div class="ttname"><a href="tracer_8h.html#a631562f73427c2710771736e1a521089">tracer_derive_aem</a></div><div class="ttdeci">tracer_aem tracer_derive_aem(tracer_aemk aemk, tracer_rpi rpi, tracer_metadata metadata)</div><div class="ttdoc">Encrypts metadata given an Associated Encrypted Metadata Key and Rolling Proximity Identifier.</div><div class="ttdef"><b>Definition:</b> tracer.h:244</div></div>
<div class="ttc" id="atracer_8h_html_a71cc1557149895133059388f0e60f57a"><div class="ttname"><a href="tracer_8h.html#a71cc1557149895133059388f0e60f57a">tracer_get_latest_tek</a></div><div class="ttdeci">tracer_tek tracer_get_latest_tek()</div><div class="ttdoc">Gets the latest Temporary Exposure Key generated.</div><div class="ttdef"><b>Definition:</b> tracer.h:314</div></div>
<div class="ttc" id="atracer_8h_html_a8a38ceec0a0cb58bc87e43287d8cea57"><div class="ttname"><a href="tracer_8h.html#a8a38ceec0a0cb58bc87e43287d8cea57">tracer_derive_ble_payload</a></div><div class="ttdeci">tracer_ble_payload tracer_derive_ble_payload(tracer_datapair datapair)</div><div class="ttdoc">Derives a new raw BLE payload given a datapair.</div><div class="ttdef"><b>Definition:</b> tracer.h:271</div></div>
<div class="ttc" id="atracer_8h_html_a0aadea78bf29be28f5822988e1be642a"><div class="ttname"><a href="tracer_8h.html#a0aadea78bf29be28f5822988e1be642a">tracer_compare_datapairs</a></div><div class="ttdeci">bool tracer_compare_datapairs(tracer_datapair a, tracer_datapair b)</div><div class="ttdoc">Compares the value of two datapairs.</div><div class="ttdef"><b>Definition:</b> tracer.h:196</div></div>
<div class="ttc" id="atracer__crypto_8h_html_a2e31ec2155c3ba41fa15169deecd1f05"><div class="ttname"><a href="tracer__crypto_8h.html#a2e31ec2155c3ba41fa15169deecd1f05">flip_aes_block_ctr</a></div><div class="ttdeci">uint8_t * flip_aes_block_ctr(void *key, size_t key_len, uint8_t iv[16], void *data, size_t data_len, void *output)</div><div class="ttdoc">Performs a AES-CTR operation on a variable-length block.</div><div class="ttdef"><b>Definition:</b> tracer_crypto.h:170</div></div>
<div class="ttc" id="atracer_8h_html_af2acdc5098bfd7ab07cfd053f059962e"><div class="ttname"><a href="tracer_8h.html#af2acdc5098bfd7ab07cfd053f059962e">tracer_derive_rpi</a></div><div class="ttdeci">tracer_rpi tracer_derive_rpi(tracer_rpik rpik, uint32_t epoch)</div><div class="ttdoc">Encrypts a Rolling Proximity Identifier from an RPIK and UNIX epoch.</div><div class="ttdef"><b>Definition:</b> tracer.h:175</div></div>
<div class="ttc" id="atracer_8h_html_a5e2a646f64065538e3f42937beb61454"><div class="ttname"><a href="tracer_8h.html#a5e2a646f64065538e3f42937beb61454">tracer_derive_keypair</a></div><div class="ttdeci">tracer_keypair tracer_derive_keypair(tracer_tek tek)</div><div class="ttdoc">Derives a tracer keypair for generating an RPI and AEM.</div><div class="ttdef"><b>Definition:</b> tracer.h:258</div></div>
<div class="ttc" id="atracer_8h_html_a58173ac16d4cb9eb3a115955b1d28b65"><div class="ttname"><a href="tracer_8h.html#a58173ac16d4cb9eb3a115955b1d28b65">tracer_detect_scanin_rollover</a></div><div class="ttdeci">bool tracer_detect_scanin_rollover(uint32_t last_epoch, uint32_t current_epoch)</div><div class="ttdoc">Detects whether or not there should be a BLE scan performed.</div><div class="ttdef"><b>Definition:</b> tracer.h:376</div></div>
<div class="ttc" id="astructtracer__keypair_html_a6d83577d61e28497337bf7719e088f21"><div class="ttname"><a href="structtracer__keypair.html#a6d83577d61e28497337bf7719e088f21">tracer_keypair::aemk</a></div><div class="ttdeci">tracer_aemk aemk</div><div class="ttdef"><b>Definition:</b> tracer.h:97</div></div>
<div class="ttc" id="atracer_8h_html_ac10f55b7d776b6fdc6b70c3e0dd4de39"><div class="ttname"><a href="tracer_8h.html#ac10f55b7d776b6fdc6b70c3e0dd4de39">tracer_detect_enin_rollover</a></div><div class="ttdeci">bool tracer_detect_enin_rollover(uint32_t last_epoch, uint32_t current_epoch)</div><div class="ttdoc">Detects if there has been an ENIntervalNumber rollover.</div><div class="ttdef"><b>Definition:</b> tracer.h:365</div></div>
<div class="ttc" id="atracer_8h_html_a4a35291fe76864b6ceb28dc91530cafd"><div class="ttname"><a href="tracer_8h.html#a4a35291fe76864b6ceb28dc91530cafd">tracer_en_interval_number</a></div><div class="ttdeci">uint32_t tracer_en_interval_number(uint32_t epoch)</div><div class="ttdoc">Gets the ENIntervalNumber given an epoch.</div><div class="ttdef"><b>Definition:</b> tracer.h:134</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
