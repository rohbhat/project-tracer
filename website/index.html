<!DOCTYPE html>

<html>
    <head>
        <style>
            * {
                font-family: Arial, Helvetica, sans-serif;
            }
            #card {
                width: 86mm;
                height: 54mm;
                border-radius: 3.5mm;
                text-align: center;
                display: table-cell;
                vertical-align: middle;
                /*background-color: black;*/
                border: 5px dashed black;
            }
        </style>
    </head>
    <body>
        <div id="card"></div>
        <h1>
            <ol>
                <li>click on the card to enable data transfer</li>
                <li>place your tracer card on top of flashing box</li>
                <li>wait for the tracer card to stop blinking</li>
                <li>click on the card again to stop data transfer</li>
            </ol>
        </h1>
        <script>
            let card = document.getElementById("card");

            //let data = 0b10101010101010101010101010101010;

            const settings = {
                lo_time: 1,
                head_len: 8,
            };

            function toBitArray(number, numBits) {
                let out = [];
                for (let i = 0; i < numBits; i++) {
                    out.push(!!(number & (1 << i)));
                }
                return out;
            }

            // transmits an array of data bits
            function tx(dataString) {
                const [lo, hi, head] = [settings.lo_time, settings.lo_time * 2, settings.lo_time * 3];
                let frameSchedule = Array(settings.head_len).fill(head).concat(dataString.map(a => [1, 2][+a]));
                let index = 0;

                return new Promise(resolve => {
                    function onFrame(time) {
                        if (frameSchedule[index]-- === 0) index++;
                        card.style.backgroundColor = ["black", "white"][index % 2];

                        if (index < frameSchedule.length) window.requestAnimationFrame(onFrame);
                        else {
                            card.style.borderColor = "black";
                            resolve()
                        }
                    }

                    window.requestAnimationFrame(onFrame);
                });
            }

            
            async function transmit() {
                if (!("txfn" in this)) {
                    let data = (Date.now() / 1000) | 0;
                    let bitArray = toBitArray(data, 32);
                    this.transmitting = false;
                    let parentThis = this;
                    let txfn = function () {
                        if (parentThis.transmitting) tx(bitArray).then(txfn);
                    };
                    this.txfn = txfn;
                }
                this.transmitting ^= true;
                if (this.transmitting) this.txfn();
                else card.style.borderColor = "white";
            }

            card.addEventListener("click", transmit);
        </script>
    </body>
</html>