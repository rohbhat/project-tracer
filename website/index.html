<!DOCTYPE html>

<html>
    <head>
        <style>
            * {
                font-family: Arial, Helvetica, sans-serif;
            }
            #card {
                width: 86mm;
                height: 54mm;
                border-radius: 3.5mm;
                text-align: center;
                display: table-cell;
                vertical-align: middle;
                /*background-color: black;*/
                border: 5px dashed black;
            }
        </style>
    </head>
    <body>
        <div id="card"></div>
        <h1 id="transferProgress"></h1>
        <h1>
            <ol>
                <li>click on the card to enable data transfer</li>
                <li>place your tracer card on top of flashing box</li>
                <li>wait for the tracer card to stop blinking</li>
                <li>click on the card again to stop data transfer</li>
            </ol>
        </h1>
        <script>
            let card = document.getElementById("card");
            let txTime = 0;

            //let data = 0b10101010101010101010101010101010;

            const settings = {
                lo_time: 1,
                head_len: 8,
                tx_data: "hello world!",
            };

            function toBitArray(number, numBits) {
                let out = [];
                for (let i = 0; i < numBits; i++) {
                    out.push(!!(number & (1 << i)));
                }
                return out;
            }

            function str2BitArray(string) {
                let out = [];
                for (let i = 0; i < string.length; i++) {
                    out = [...out, ...toBitArray(string.charCodeAt(i), 8)];
                }
                return out;
            }

            // transmits an array of data bits
            function tx(dataString, progressCallback) {
                const [lo, hi, head] = [settings.lo_time, settings.lo_time * 2, settings.lo_time * 3];

                // format is head => data => head

                let frameSchedule = Array(settings.head_len).fill(head).concat(dataString.map(a => [1, 2][+a])).concat(Array(settings.head_len).fill(head));

                txTime = frameSchedule.reduce((a, b) => a + b) * (1/60);
                console.log(`data transfer will take around ${txTime.toPrecision(2)}s.`)

                let index = 0;

                return new Promise(resolve => {
                    function onFrame(time) {
                        if (frameSchedule[index]-- === 0) index++;
                        card.style.backgroundColor = ["black", "white"][index % 2];

                        if (progressCallback) progressCallback(index / frameSchedule.length);

                        if (index < frameSchedule.length) window.requestAnimationFrame(onFrame);
                        else {
                            card.style.borderColor = "black";
                            resolve()
                        }
                    }

                    window.requestAnimationFrame(onFrame);
                });
            }

            
            async function transmit() {
                let bitArray = str2BitArray(settings.tx_data);
                let parentThis = this
                if (parentThis.txdone || !("txdone" in parentThis)) {
                    parentThis.txdone = false;
                    tx(bitArray, v => document.getElementById("transferProgress").innerText = `${(v*100).toPrecision(3)}% done! (estimated transfer is ${txTime.toPrecision(2)}s)`).then(() => parentThis.txdone = true);
                }                    
                
            }

            card.addEventListener("click", transmit);
        </script>
    </body>
</html>